# Autogenerated - DO NOT MODIFY THIS FILE DIRECTLY 
# If you want to overwrite some of these values with your own customizations,
# please add them to `override/bn.yml`.
# 
# See https://docs.docker.com/compose/extends/#adding-and-overriding-configuration
# for more information on overriding specific parameters of docker-compose files.

version: "3.7"
services:
  bn:
    image: {{.GetBnContainerTag}}
    user: root
    container_name: {{.ProjectName}}_bn
    restart: unless-stopped
    stop_grace_period: 3m
    {{- $p2p := (or .LocalBeaconConfig.P2pPort.String "9001")}}
    ports:
      - "{{$p2p}}:{{$p2p}}/udp"
      - "{{$p2p}}:{{$p2p}}/tcp"
      {{- if eq .LocalBeaconConfig.BeaconNode.String "lighthouse"}}
      - "{{.LocalBeaconConfig.Lighthouse.P2pQuicPort}}:{{.LocalBeaconConfig.Lighthouse.P2pQuicPort}}/udp"
      {{- end}}
      {{- range $entry := .GetBnOpenPorts}}
      - "{{$entry}}"
      {{- end}}
    volumes:
      - bndata:/ethclient
      - /usr/share/hyperdrive/scripts:/setup:ro
      - /var/lib/hyperdrive/data/{{.ProjectName}}:/secrets:ro
    networks:
      - net
    environment:
      - NETWORK={{.Network}}
      - EC_CLIENT={{if .IsLocalMode}}{{.LocalExecutionConfig.ExecutionClient}}{{else}}{{.ExternalExecutionConfig.ExecutionClient}}{{end}}
      - CC_CLIENT={{if .IsLocalMode}}{{.LocalBeaconConfig.BeaconNode}}{{else}}{{.ExternalBeaconConfig.BeaconNode}}{{end}}
      - EC_HTTP_ENDPOINT={{.GetEcHttpEndpoint}}
      - EC_WS_ENDPOINT={{.GetEcWsEndpoint}}
      - EC_ENGINE_ENDPOINT=http://{{.GetExecutionHostname}}:{{.LocalExecutionConfig.EnginePort}}
      - EC_ENGINE_WS_ENDPOINT=ws://{{.GetExecutionHostname}}:{{.LocalExecutionConfig.EnginePort}}
      - BN_P2P_PORT={{$p2p}}
      - BN_API_PORT={{.LocalBeaconConfig.HttpPort}}
      - BN_MAX_PEERS={{.GetBnMaxPeers}}
      - ENABLE_METRICS={{.Metrics.EnableMetrics}}
      - BN_METRICS_PORT={{.Metrics.BnMetricsPort}}
      - EXTERNAL_IP={{.GetExternalIP}}
      - CHECKPOINT_SYNC_URL={{.LocalBeaconConfig.CheckpointSyncProvider}}
      - BN_ADDITIONAL_FLAGS={{.GetBnAdditionalFlags}}
      - ENABLE_BITFLY_NODE_METRICS={{.Metrics.EnableBitflyNodeMetrics}}
      - BITFLY_NODE_METRICS_SECRET={{.Metrics.BitflyNodeMetrics.Secret}}
      - BITFLY_NODE_METRICS_ENDPOINT={{.Metrics.BitflyNodeMetrics.Endpoint}}
      - BITFLY_NODE_METRICS_MACHINE_NAME={{.Metrics.BitflyNodeMetrics.MachineName}}
      {{- /* Client-specific values */}}
      {{- if eq .LocalBeaconConfig.BeaconNode.String "teku"}}
      - TEKU_JVM_HEAP_SIZE={{.LocalBeaconConfig.Teku.JvmHeapSize}}
      - TEKU_ARCHIVE_MODE={{.LocalBeaconConfig.Teku.ArchiveMode}}
      {{- else if eq .LocalBeaconConfig.BeaconNode.String "prysm"}}
      - BN_RPC_PORT={{.LocalBeaconConfig.Prysm.RpcPort}}
      {{- else if eq .LocalBeaconConfig.BeaconNode.String "nimbus"}}
      - NIMBUS_PRUNING_MODE={{.LocalBeaconConfig.Nimbus.PruningMode}}
      {{- else if eq .LocalBeaconConfig.BeaconNode.String "lighthouse"}}
      - BN_P2P_QUIC_PORT={{.Lighthouse.LocalBeaconConfig.P2pQuicPort}}
      {{- end}}
    entrypoint: sh
    command: "/setup/start-bn.sh"
    cap_drop:
      - all
    cap_add:
      - dac_override
    security_opt:
      - no-new-privileges
networks:
  net:
volumes:
  bndata:
